<html>
<head>
    <meta>
    <title>Contact Bulk Editor</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap.min.css" rel="stylesheet" type="text/css" />
</head>
<body>

    <h4>Contacts <button class="btn btn-sm btn-success" onclick="location.reload();">Refresh</button></h4>
    <hr>
    <p id="sts" style="padding-left:20px; font-weight: bold;"></p>
    <div id="gridContainer" style="padding:20px; max-height:400px; overflow:auto"></div>
    
    <div class="container">
        <div class="row" style="margin-top: 20px;">
            <div class="col-xs-12">
                <button class='btn btn-primary' onclick="processRecords('activate');">Activate</button>
                <button class='btn btn-danger' onclick="processRecords('deactivate');">Deactivate</button>
                <button class='btn btn-info' onclick="processRecords('updateCurrency');">Update to USD</button>
            </div>
        </div>
    </div>
    
    <div class="container bg-warning" style="margin-top: 20px; padding:20px; border-radius: 5px;">
        <h4>Update Job Title</h4>
        <div class="form-inline">
            <div class="form-group">
                <input type="text" id="txtJobTitle" class="form-control" placeholder="Enter new job title" />
            </div>
            <button class='btn btn-dark' onclick="processRecords('updateJobTitle');">Update Job Title</button>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // Get the parent Account ID in a reliable, supported way.
            const accountId = parent.Xrm.Page.data.entity.getId().replace(/[{}]/g, "");

            if (!accountId) {
                setStatus("Could not find the parent Account ID.", "error");
                return;
            }

            // Define the FetchXML query
            const fetchXml = `?fetchXml=<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false'>
                                <entity name='contact'>
                                    <attribute name='contactid' />
                                    <attribute name='fullname' />
                                    <attribute name='transactioncurrencyid' />
                                    <attribute name='preferredcontactmethodcode' />
                                    <attribute name='statecode' />
                                    <attribute name='jobtitle' />
                                    <order attribute='fullname' descending='false' />
                                    <filter type='and'>
                                        <condition attribute='parentcustomerid' operator='eq' value='${accountId}' />
                                    </filter>
                                </entity>
                            </fetch>`;

            // CORRECTED: Use Xrm.WebApi.retrieveMultipleRecords with the proper options format
            Xrm.WebApi.retrieveMultipleRecords("contact", fetchXml).then(
                function success(result) {
                    if (result.entities.length === 0) {
                        setStatus("No contacts found for this account.", "info");
                        return;
                    }
                    buildDataTable(result.entities);
                },
                function (error) {
                    setStatus(`Error retrieving records: ${error.message}`, "error");
                }
            );
        });

        function buildDataTable(entities) {
            let table = `<table id='contactsTable' class='table table-striped table-bordered' style='width:100%'>
                            <thead>
                                <tr>
                                    <th><input id='checkboxAll' type='checkbox' onchange='toggleAll(this);'></th>
                                    <th>Full Name</th>
                                    <th>Currency</th>
                                    <th>Preferred Contact</th>
                                    <th>Status</th>
                                    <th>Job Title</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            entities.forEach(entity => {
                const currency = entity["_transactioncurrencyid_value@OData.Community.Display.V1.FormattedValue"] || "";
                const contactMethod = entity["preferredcontactmethodcode@OData.Community.Display.V1.FormattedValue"] || "";
                const status = entity["statecode@OData.Community.Display.V1.FormattedValue"] || "";
                const jobTitle = entity.jobtitle || "";

                table += `<tr>
                            <td><input type='checkbox' class='chkNumber' value='${entity.contactid}'></td>
                            <td>${entity.fullname}</td>
                            <td>${currency}</td>
                            <td>${contactMethod}</td>
                            <td>${status}</td>
                            <td>${jobTitle}</td>
                          </tr>`;
            });

            table += `</tbody></table>`;
            $('#gridContainer').html(table);

            // Initialize the DataTable plugin
            $('#contactsTable').DataTable({
                "pageLength": 5,
                "pagingType": "simple_numbers",
                "lengthChange": false,
                "filter": true,
                "info": false,
                "searching": true
            });
        }

        function toggleAll(source) {
            const checkboxes = document.querySelectorAll('.chkNumber');
            for (let checkbox of checkboxes) {
                checkbox.checked = source.checked;
            }
        }

        /**
         * Generic function to process selected records. It handles UI feedback and runs updates in parallel.
         * @param {string} operation - The action to perform ('activate', 'deactivate', etc.)
         */
        async function processRecords(operation) {
            const selectedIds = getSelectedRecordIds();
            if (selectedIds.length === 0) {
                alert("Please select at least one record.");
                return;
            }

            setStatus(`Processing ${selectedIds.length} record(s)... Please wait.`, "info");
            let promises = [];

            // Create an array of promises for all the update operations
            for (const id of selectedIds) {
                switch (operation) {
                    case 'activate':
                        promises.push(updateContactStatus(id, 0, 1)); // 0 = Active, 1 = Active
                        break;
                    case 'deactivate':
                        promises.push(updateContactStatus(id, 1, 2)); // 1 = Inactive, 2 = Inactive
                        break;
                    case 'updateCurrency':
                        promises.push(updateContactCurrency(id));
                        break;
                    case 'updateJobTitle':
                        const newTitle = $('#txtJobTitle').val();
                        if (!newTitle) {
                            alert("Please enter a job title.");
                            return;
                        }
                        promises.push(updateContactJobTitle(id, newTitle));
                        break;
                }
            }
            
            try {
                // Wait for ALL promises to resolve
                await Promise.all(promises);
                setStatus(`${selectedIds.length} record(s) processed successfully. Click Refresh to see changes.`, "success");
            } catch (error) {
                setStatus(`An error occurred during the update: ${error.message}`, "error");
            }
        }

        function getSelectedRecordIds() {
            return Array.from(document.querySelectorAll('.chkNumber:checked')).map(cb => cb.value);
        }

        // --- ASYNCHRONOUS UPDATE FUNCTIONS ---

        function updateContactStatus(id, statecode, statuscode) {
            const data = {
                "statecode": statecode,
                "statuscode": statuscode
            };
            // CORRECTED: Using the modern, asynchronous Xrm.WebApi.updateRecord
            return Xrm.WebApi.updateRecord("contact", id, data);
        }

        function updateContactCurrency(id) {
            const usdCurrencyId = "cf8b234e-2798-ec11-b400-000d3a300c9c"; // Hardcoded USD GUID
            const data = {
                "transactioncurrencyid@odata.bind": `/transactioncurrencies(${usdCurrencyId})`
            };
            return Xrm.WebApi.updateRecord("contact", id, data);
        }

        function updateContactJobTitle(id, title) {
            const data = {
                "jobtitle": title
            };
            return Xrm.WebApi.updateRecord("contact", id, data);
        }

        function setStatus(message, type) {
            const statusElement = $('#sts');
            statusElement.text(message);
            statusElement.removeClass('text-success text-danger text-info').addClass(
                type === 'success' ? 'text-success' : (type === 'error' ? 'text-danger' : 'text-info')
            );
        }
    </script>
</body>
</html>